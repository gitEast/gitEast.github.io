<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        郑鳄
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            小鳄鱼写代码之Mini-Vue的响应式系统
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h2 id="一、粗糙的响应系统"><a href="#一、粗糙的响应系统" class="headerlink" title="一、粗糙的响应系统"></a>一、粗糙的响应系统</h2><blockquote>
<p>对一个对象的值，进行追踪，对于使用了该值的函数，该值变化时，这些函数需被再次调用</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> render <span class="keyword">from</span> <span class="string">&#x27;./renderer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> h <span class="keyword">from</span> <span class="string">&#x27;./renderer/h&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)!;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>]),</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;她今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;herAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>])</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">render(vnode, container);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 设计一个对象，追踪年龄</span></span><br><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Crocodile&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myAge&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> herAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;herAge&#x27;</span>)!;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用了该值的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showYourAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  myAgeEl.innerText = <span class="string">`<span class="subst">$&#123;person.age&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showHerAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  herAgeEl.innerText = <span class="string">`<span class="subst">$&#123;person.age + <span class="number">20</span>&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> button = <span class="built_in">document</span>.createElement(<span class="string">&#x27;button&#x27;</span>);</span><br><span class="line">button.textContent = <span class="string">&#x27;过去了一年&#x27;</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(button);</span><br><span class="line">button.onclick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  person.age++;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">showYourAge();</span><br><span class="line">showHerAge();</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/1.png" alt="效果图"></p>
<p>在上述案例中点击按钮“过去了一年”，<code>person.age</code> 会增加 1，对应的<br>变化</p>
<ul>
<li>“我今年 24 岁” =&gt; “我今年 25 岁”</li>
<li>“她今年 44 岁” =&gt; “她今年 45 岁”</li>
</ul>
<p>由于 Vue3 通过将对象包裹成 <code>Proxy</code> 对象并拦截对其的读写操作从而实现响应式系统，因此，我们需要将 <code>person</code> 对象进行包裹</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> personObj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Crocodile&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="built_in">Proxy</span>(personObj, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>此时，我们已经能拦截到读取操作了，但如何知道哪个函数被调用了呢？</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> activeEffect: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">  fn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">effect(showYourAge);</span><br><span class="line">effect(showHerAge);</span><br></pre></td></tr></table></figure>

<ol>
<li>使用全局变量 <code>activeEffect</code> 用于记录当前被调用的函数</li>
<li>使用 <code>effect</code> 包裹函数的调用，实现 1 中记录操作</li>
</ol>
<p>前置操作都已完成，可以来实现一个粗糙的响应式系统了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于记录当前被调用的函数</span></span><br><span class="line"><span class="keyword">let</span> activeEffect: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">  fn();</span><br><span class="line">  <span class="comment">// 记得及时清空记录啊喂！不然 personAgeFns 收集的时候，万一有别的不相干的函数被调用，也收集进来了</span></span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> personAgeFns = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;<span class="built_in">Function</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="built_in">Proxy</span>(personObj, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 收集所有依赖函数</span></span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      personAgeFns.add(activeEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, p, newValue, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, p, newValue, receiver);</span><br><span class="line">    <span class="comment">// 再次调用相关的依赖函数，更新数据</span></span><br><span class="line">    personAgeFns.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>至此，一个粗糙的响应式系统完成了。——至少，对 <code>person.age</code> 的响应式完成了。</p>
<h2 id="二、响应系统的核心代码"><a href="#二、响应系统的核心代码" class="headerlink" title="二、响应系统的核心代码"></a>二、响应系统的核心代码</h2><h3 id="2-1-一个对象的响应系统"><a href="#2-1-一个对象的响应系统" class="headerlink" title="2.1 一个对象的响应系统"></a>2.1 一个对象的响应系统</h3><blockquote>
<p>不积跬步无以至千里——第一步追踪对象内的值完成了，接下来可以对一整个对象进行追踪啦。<br>首先，我们要考虑的是，用什么样的数据结构来存储整个对象的依赖函数？</p>
</blockquote>
<p>对于对象的一个值，我们使用了 <code>Set</code> 结构来存储其依赖函数，那么对于整个对象，显然一个 <code>Set</code> 是不够用的，得多来几个。此时，我们就需要考虑如何管理这多个 <code>Set</code> 了。</p>
<p>对于 <code>person</code> 对象，如果 <code>person.name</code> 改变，那该响应的应该是与 <code>person.name</code> 有依赖关系的函数，<code>person.age</code> 依赖函数可不能来瞎凑热闹。在这种情况下，键值对就非常合适——该 <code>Map</code> 登场了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> personMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;<span class="built_in">string</span> | symbol, <span class="built_in">Set</span>&lt;<span class="built_in">Function</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="built_in">Proxy</span>(personObj, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!personMap.get(prop)) personMap.set(prop, <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">      personMap.get(prop)!.add(activeEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">    personMap.get(prop)?.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>校验的案例代码如下</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> render <span class="keyword">from</span> <span class="string">&#x27;./renderer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> h <span class="keyword">from</span> <span class="string">&#x27;./renderer/h&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> personMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;<span class="built_in">string</span> | symbol, <span class="built_in">Set</span>&lt;<span class="built_in">Function</span>&gt;&gt;();</span><br><span class="line"><span class="keyword">let</span> activeEffect: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">  fn();</span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 案例 1. 设计一个对象，追踪年龄</span></span><br><span class="line"><span class="keyword">const</span> personObj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Crocodile&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> person = <span class="keyword">new</span> <span class="built_in">Proxy</span>(personObj, &#123;</span><br><span class="line">  <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!personMap.get(prop)) personMap.set(prop, <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">      personMap.get(prop)!.add(activeEffect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">    personMap.get(prop)?.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>]),</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;她今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;herAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>]),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        person.age++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;过去了一年&#x27;</span>]</span><br><span class="line">  ),</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我的名字是&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myName&#x27;</span> &#125;, [])]),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        person.name = <span class="string">&#x27;East&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;改个名字&#x27;</span>]</span><br><span class="line">  )</span><br><span class="line">]);</span><br><span class="line">render(vnode, container);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myAge&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> herAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;herAge&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> myNameEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myName&#x27;</span>)!;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 案例 2. 使用了该值的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showYourAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  myAgeEl.innerText = <span class="string">`<span class="subst">$&#123;person.age&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showHerAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  herAgeEl.innerText = <span class="string">`<span class="subst">$&#123;person.age + <span class="number">20</span>&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showMyName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  myNameEl.innerText = person.name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">effect(showYourAge);</span><br><span class="line">effect(showHerAge);</span><br><span class="line">effect(showMyName);</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/2.gif" alt="效果图"></p>
<h3 id="2-2-拆分后的代码"><a href="#2-2-拆分后的代码" class="headerlink" title="2.2 拆分后的代码"></a>2.2 拆分后的代码</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> objMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;<span class="built_in">string</span> | symbol, <span class="built_in">Set</span>&lt;<span class="built_in">Function</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">  fn();</span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">prop: <span class="built_in">string</span> | symbol</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!objMap.get(prop)) objMap.set(prop, <span class="keyword">new</span> <span class="built_in">Set</span>());</span><br><span class="line">    objMap.get(prop)!.add(activeEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: <span class="built_in">string</span> | symbol</span>) </span>&#123;</span><br><span class="line">  objMap.get(prop)?.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactivity</span>(<span class="params">obj: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">      track(prop);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">      trigger(prop);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-所有对象的响应式系统"><a href="#2-3-所有对象的响应式系统" class="headerlink" title="2.3 所有对象的响应式系统"></a>2.3 所有对象的响应式系统</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Prop = <span class="built_in">string</span> | symbol;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> TargetMap = <span class="built_in">Map</span>&lt;Prop, <span class="built_in">Set</span>&lt;<span class="built_in">Function</span>&gt;&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Bucket = <span class="built_in">WeakMap</span>&lt;<span class="built_in">any</span>, TargetMap&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> bucket: Bucket = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  activeEffect = fn;</span><br><span class="line">  fn();</span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">    <span class="keyword">let</span> targetMap = bucket.get(target);</span><br><span class="line">    <span class="keyword">if</span> (!targetMap) &#123;</span><br><span class="line">      targetMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">      bucket.set(target, targetMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> fnSet = targetMap.get(prop);</span><br><span class="line">    <span class="keyword">if</span> (!fnSet) &#123;</span><br><span class="line">      fnSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">      targetMap.set(prop, fnSet);</span><br><span class="line">    &#125;</span><br><span class="line">    fnSet.add(activeEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  bucket</span><br><span class="line">    .get(target)</span><br><span class="line">    ?.get(prop)</span><br><span class="line">    ?.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactivity</span>(<span class="params">obj: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">      track(prop, target);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">      trigger(prop, target);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三、该考虑边界情况了"><a href="#三、该考虑边界情况了" class="headerlink" title="三、该考虑边界情况了"></a>三、该考虑边界情况了</h2><h3 id="3-1-分支情况下不必要的更新"><a href="#3-1-分支情况下不必要的更新" class="headerlink" title="3.1 分支情况下不必要的更新"></a>3.1 分支情况下不必要的更新</h3><p>对 <code>person</code> 增加一个参数 <code>isShowAge</code>，控制是否显示年龄</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 测试代码 */</span></span><br><span class="line"><span class="keyword">const</span> personObj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Crocodile&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">isShowAge</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> person = reactivity(personObj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>]),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        person.isShowAge = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;不显示年龄&#x27;</span>]</span><br><span class="line">  ),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        person.age++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;过去了一年&#x27;</span>]</span><br><span class="line">  )</span><br><span class="line">]);</span><br><span class="line">render(vnode, container);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myAge&#x27;</span>)!;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 案例 2. 使用了该值的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showYourAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 用于显示该函数是否被调用</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  myAgeEl.innerText = person.isShowAge ? <span class="string">`<span class="subst">$&#123;person.age&#125;</span>`</span> : <span class="string">&#x27;？&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">effect(showYourAge);</span><br></pre></td></tr></table></figure>

<p>分析上述代码，可以得出，如果 <code>person.isShowAge</code> 的值为 <code>false</code> 时，当 <code>person.age</code> 变化时，我今年的年龄应一直显示 “？”，且没有必要读取 <code>person.age</code> 的值并重新调用依赖的函数 <code>showYourAge</code>。</p>
<p>但实际上，<code>showYourAge</code> 一直在被调用。</p>
<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/3-1.gif" alt="效果图"></p>
<p>那么，当出现分支情况时，我们该如何更新依赖呢？</p>
<p>可以考虑在函数调用时，先清空它对应的依赖，再重新收集依赖。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 类型 */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Prop = <span class="built_in">string</span> | symbol;</span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> PropFns = <span class="built_in">Set</span>&lt;IEffectFn&gt;;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> TargetMap = <span class="built_in">Map</span>&lt;Prop, PropFns&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> Bucket = <span class="built_in">WeakMap</span>&lt;<span class="built_in">any</span>, TargetMap&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IEffectFn &#123;</span><br><span class="line">  <span class="attr">fnSets</span>: <span class="built_in">Set</span>&lt;PropFns&gt;;</span><br><span class="line">  (): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 响应式代码 */</span></span><br><span class="line"><span class="keyword">const</span> bucket: Bucket = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> activeEffect: IEffectFn | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cleanUp</span>(<span class="params">effectFn: IEffectFn</span>) </span>&#123;</span><br><span class="line">  effectFn.fnSets.forEach(<span class="function">(<span class="params">fnSet</span>) =&gt;</span> &#123;</span><br><span class="line">    fnSet.delete(effectFn);</span><br><span class="line">  &#125;);</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 新增</span></span><br><span class="line">  <span class="keyword">const</span> effectFn: IEffectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cleanUp(effectFn);</span><br><span class="line">    activeEffect = effectFn;</span><br><span class="line">    fn();</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="comment">// 修改</span></span><br><span class="line">  effectFn();</span><br><span class="line">  activeEffect = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">    <span class="keyword">let</span> targetMap = bucket.get(target);</span><br><span class="line">    <span class="keyword">if</span> (!targetMap) &#123;</span><br><span class="line">      targetMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">      bucket.set(target, targetMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> fnSet = targetMap.get(prop);</span><br><span class="line">    <span class="keyword">if</span> (!fnSet) &#123;</span><br><span class="line">      fnSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">      targetMap.set(prop, fnSet);</span><br><span class="line">    &#125;</span><br><span class="line">    fnSet.add(activeEffect);</span><br><span class="line">    <span class="comment">// 新增</span></span><br><span class="line">    activeEffect.fnSets.add(fnSet);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 修改</span></span><br><span class="line">  <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="built_in">Set</span>(bucket.get(target)?.get(prop));</span><br><span class="line">  effectsToRun.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactivity</span>(<span class="params">obj: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">      track(prop, target);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">      trigger(prop, target);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-嵌套执行函数"><a href="#3-2-嵌套执行函数" class="headerlink" title="3.2 嵌套执行函数"></a>3.2 嵌套执行函数</h3><p>如果我们嵌套执行函数，但全局参数 <code>activeEffect</code> 只能记录一个函数或已置为 <code>null</code>，此时，依赖的收集可能会发生错误（不够完善）</p>
<ul>
<li>外层函数内代码全部执行完毕后再执行内部嵌套函数 =&gt; 依赖收集不会发生错误</li>
<li>外层函数内有代码在内部嵌套函数后执行 =&gt; 在内部嵌套函数后的依赖无法收集</li>
</ul>
<h4 id="3-2-1-案例"><a href="#3-2-1-案例" class="headerlink" title="3.2.1 案例"></a>3.2.1 案例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 案例 1. 设计一个对象，追踪年龄</span></span><br><span class="line"><span class="keyword">let</span> age = <span class="number">24</span>;</span><br><span class="line"><span class="keyword">let</span> isShowAge = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> personObj = &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Crocodile&#x27;</span>,</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">isShowAge</span>: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> person = reactivity(personObj);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;root&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> vnode = h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我今年&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myAge&#x27;</span> &#125;, []), <span class="string">&#x27;岁&#x27;</span>]),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        isShowAge = !isShowAge;</span><br><span class="line">        person.isShowAge = isShowAge;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;不显示年龄&#x27;</span>]</span><br><span class="line">  ),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        age++;</span><br><span class="line">        person.age = age;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;过去了一年&#x27;</span>]</span><br><span class="line">  ),</span><br><span class="line">  h(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, [<span class="string">&#x27;我的名字是&#x27;</span>, h(<span class="string">&#x27;span&#x27;</span>, &#123; <span class="attr">id</span>: <span class="string">&#x27;myName&#x27;</span> &#125;, [])]),</span><br><span class="line">  h(</span><br><span class="line">    <span class="string">&#x27;button&#x27;</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function"><span class="title">onClick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        person.name = <span class="string">&#x27;East&#x27;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    [<span class="string">&#x27;改个名字&#x27;</span>]</span><br><span class="line">  )</span><br><span class="line">]);</span><br><span class="line">render(vnode, container);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myAgeEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myAge&#x27;</span>)!;</span><br><span class="line"><span class="keyword">const</span> myNameEl = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;myName&#x27;</span>)!;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 案例 2. 使用了该值的函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showYourAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  effect(showMyName);</span><br><span class="line">  myAgeEl.innerText = person.isShowAge ? <span class="string">`<span class="subst">$&#123;person.age&#125;</span>`</span> : <span class="string">&#x27;？&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showMyName</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  myNameEl.innerText = person.name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">effect(showYourAge);</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-函数调用栈"><a href="#3-2-2-函数调用栈" class="headerlink" title="3.2.2 函数调用栈"></a>3.2.2 函数调用栈</h4><p>借助栈结构记录当前调用函数：每调用一个函数，就将其压入栈；每当一个函数被调用结束，就将其弹出栈。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bucket: Bucket = <span class="keyword">new</span> <span class="built_in">WeakMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> activeEffectStack: IEffectFn[] = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cleanUp</span>(<span class="params">effectFn: IEffectFn</span>) </span>&#123;</span><br><span class="line">  effectFn.fnSets.forEach(<span class="function">(<span class="params">fnSet</span>) =&gt;</span> &#123;</span><br><span class="line">    fnSet.delete(effectFn);</span><br><span class="line">  &#125;);</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn: IEffectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cleanUp(effectFn);</span><br><span class="line">    activeEffectStack.push(effectFn);</span><br><span class="line">    fn();</span><br><span class="line">    activeEffectStack.pop();</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  effectFn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> activeEffect = activeEffectStack[activeEffectStack.length - <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> (activeEffect) &#123;</span><br><span class="line">    <span class="keyword">let</span> targetMap = bucket.get(target);</span><br><span class="line">    <span class="keyword">if</span> (!targetMap) &#123;</span><br><span class="line">      targetMap = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">      bucket.set(target, targetMap);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> fnSet = targetMap.get(prop);</span><br><span class="line">    <span class="keyword">if</span> (!fnSet) &#123;</span><br><span class="line">      fnSet = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">      targetMap.set(prop, fnSet);</span><br><span class="line">    &#125;</span><br><span class="line">    fnSet.add(activeEffect);</span><br><span class="line">    activeEffect.fnSets.add(fnSet);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="built_in">Set</span>(bucket.get(target)?.get(prop));</span><br><span class="line">  effectsToRun.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reactivity</span>(<span class="params">obj: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="function"><span class="title">get</span>(<span class="params">target, prop, receiver</span>)</span> &#123;</span><br><span class="line">      track(prop, target);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Reflect</span>.get(target, prop, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">set</span>(<span class="params">target, prop, newValue, receiver</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="built_in">Reflect</span>.set(target, prop, newValue, receiver);</span><br><span class="line">      trigger(prop, target);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-无限递归循环"><a href="#3-3-无限递归循环" class="headerlink" title="3.3 无限递归循环"></a>3.3 无限递归循环</h3><h4 id="3-3-1-案例"><a href="#3-3-1-案例" class="headerlink" title="3.3.1 案例"></a>3.3.1 案例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">effect(<span class="function">() =&gt;</span> person.age++);</span><br><span class="line"><span class="comment">// 即</span></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  person.age = person.age + <span class="number">1</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>该函数进行的步骤：</p>
<ol>
<li>先执行等号右侧的读取操作 <code>get</code>，执行 <code>track</code> 将该匿名函数收集进 <code>person.age</code> 对应的依赖</li>
<li>然后执行等号左侧的写入操作 <code>set</code>，执行 <code>trigger</code> 函数，重新执行 <code>person.age</code> 的对应依赖函数</li>
<li>还没等匿名函数调用完毕，又调用了自己，依次循环，永无结束之时。——不好意思，有的，报错：<code>Uncaught RangeError: Maximum call stack size exceeded</code></li>
</ol>
<h4 id="3-3-2-碰着自己，就别动手了"><a href="#3-3-2-碰着自己，就别动手了" class="headerlink" title="3.3.2 碰着自己，就别动手了"></a>3.3.2 碰着自己，就别动手了</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="built_in">Set</span>(bucket.get(target)?.get(prop));</span><br><span class="line">  <span class="comment">// 修改的地方</span></span><br><span class="line">  effectsToRun.forEach(</span><br><span class="line">    <span class="function">(<span class="params">fn</span>) =&gt;</span> fn !== activeEffectStack[activeEffectStack.length - <span class="number">1</span>] &amp;&amp; fn()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="四、其他功能"><a href="#四、其他功能" class="headerlink" title="四、其他功能"></a>四、其他功能</h2><blockquote>
<p>基于响应系统，实现一些其他的功能：<code>computed</code>, <code>watch</code>, …</p>
</blockquote>
<h3 id="4-1-调度执行"><a href="#4-1-调度执行" class="headerlink" title="4.1 调度执行"></a>4.1 调度执行</h3><p>即，控制副作用函数执行的时机</p>
<h4 id="4-1-1-案例-1-改变执行时机"><a href="#4-1-1-案例-1-改变执行时机" class="headerlink" title="4.1.1 案例 1 改变执行时机"></a>4.1.1 案例 1 改变执行时机</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">isShowMomAge</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(person.age);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;------&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-1-1-1.png" alt="效果图"></p>
<p>而现在的要求是，将横杠置于年龄变化之间。</p>
<p>这种无理的要求，我们 <code>effect</code> 函数肯定不会实现的，毕竟千人千面，有的需要这个功能有的不需要这个功能，怎能统一实现呢？不过，不借助 <code>effect</code> 的帮助，也是实现不了的。因此，我们可以对 <code>effect</code> 传入可选参数 <code>options</code>，自行实现这个功能</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类型修改</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IEffectFn &#123;</span><br><span class="line">  <span class="attr">fnSets</span>: <span class="built_in">Set</span>&lt;PropFns&gt;;</span><br><span class="line">  options?: IEffectOption;</span><br><span class="line">  (): <span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> IEffectOption &#123;</span><br><span class="line">  scheduler?: <span class="built_in">Function</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用时 增加 options.schedule</span></span><br><span class="line">effect(</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(person.age);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// setTimeout 当然也能实现，但我偏好 Promise 的做法</span></span><br><span class="line">      <span class="comment">// setTimeout(() =&gt; fn());</span></span><br><span class="line">      <span class="built_in">Promise</span>.resolve().then(<span class="function">() =&gt;</span> fn());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// effect 函数的修改</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span>, options?: IEffectOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn: IEffectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cleanUp(effectFn);</span><br><span class="line">    activeEffectStack.push(effectFn);</span><br><span class="line">    fn();</span><br><span class="line">    activeEffectStack.pop();</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="comment">// 记录 options</span></span><br><span class="line">  effectFn.options = options;</span><br><span class="line">  effectFn();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调整触发条件</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">trigger</span>(<span class="params">prop: Prop, target: <span class="built_in">any</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectsToRun = <span class="keyword">new</span> <span class="built_in">Set</span>(bucket.get(target)?.get(prop));</span><br><span class="line">  effectsToRun.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fn === activeEffectStack[activeEffectStack.length - <span class="number">1</span>]) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (fn.options?.scheduler) &#123;</span><br><span class="line">      fn.options.scheduler(fn);</span><br><span class="line">    &#125; <span class="keyword">else</span> fn();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-1-1-2.png" alt="效果图"></p>
<h4 id="4-1-2-案例-2-减少中间过程的执行"><a href="#4-1-2-案例-2-减少中间过程的执行" class="headerlink" title="4.1.2 案例 2 减少中间过程的执行"></a>4.1.2 案例 2 减少中间过程的执行</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span>,</span><br><span class="line">  <span class="attr">isShowMomAge</span>: <span class="literal">true</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">effect(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(person.age);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-1-2-1.png" alt="效果图"></p>
<p>现在的要求是，25 作为中间状态，不显示，只显示必要的首个状态 24 与结束状态 25。</p>
<p>在 4.1.1 中，已经知道了 <code>options.schedule</code> 的参数是被执行的副作用函数，因此可以再次改造 <code>schedule</code>，将拿到的函数作为一个队列，依次执行。（当任务队列使用 <code>Set</code> 时，自动去重函数，即可实现中间状态不显示）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">oneUpdate(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(person.age);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">oneUpdate</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> jobQueue = <span class="keyword">new</span> <span class="built_in">Set</span>&lt;IEffectFn&gt;();</span><br><span class="line">  <span class="keyword">let</span> isFlush = <span class="literal">false</span>;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flushJob</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFlush) <span class="keyword">return</span>;</span><br><span class="line">    isFlush = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">Promise</span>.resolve()</span><br><span class="line">      .then(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        jobQueue.forEach(<span class="function">(<span class="params">fn</span>) =&gt;</span> fn());</span><br><span class="line">      &#125;)</span><br><span class="line">      .finally(<span class="function">() =&gt;</span> (isFlush = <span class="literal">false</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  effect(fn, &#123;</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params">fn</span>)</span> &#123;</span><br><span class="line">      jobQueue.add(fn);</span><br><span class="line">      flushJob();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-计算属性-computed"><a href="#4-2-计算属性-computed" class="headerlink" title="4.2 计算属性 computed"></a>4.2 计算属性 <code>computed</code></h3><p>什么是计算属性？</p>
<ol>
<li>基于响应系统的值（基础值）运算得到的数据</li>
<li>有缓存机制，如果基础值不变，就不会重新计算；如果基础值发生变化，则重新计算</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> momAge = computed(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = person.age + person.ageBase;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`妈妈的年龄计算了<span class="subst">$&#123;++count&#125;</span>次`</span>);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 对应的实现 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">computedFn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(computedFn);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      <span class="keyword">return</span> effectFn();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span>, options?: IEffectOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn: IEffectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cleanUp(effectFn);</span><br><span class="line">    activeEffectStack.push(effectFn);</span><br><span class="line">    <span class="comment">// 获取返回值</span></span><br><span class="line">    <span class="keyword">const</span> res = fn();</span><br><span class="line">    activeEffectStack.pop();</span><br><span class="line">    <span class="comment">// 返回真正的结果</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  effectFn.options = options;</span><br><span class="line">  effectFn();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回函数，使得 computed 函数内部可以重新调用该函数得到值</span></span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-2-1.png" alt="效果图"></p>
<p>存在的问题：</p>
<ol>
<li>最开始没有使用 <code>momAge.value</code> 时，妈妈的年龄也被计算了</li>
<li>值没有发生改变，却重新计算了</li>
</ol>
<p>解决办法：</p>
<ol>
<li>对 <code>effect</code> 再次通过 <code>options</code> 来控制是否第一次就执行</li>
<li>增加缓存机制</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">computedFn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value;</span><br><span class="line">  <span class="keyword">let</span> isDirty = <span class="literal">true</span>; <span class="comment">// 判断是否需要调用计算函数</span></span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(computedFn, &#123;</span><br><span class="line">    <span class="comment">// 懒调用：第一次不调用，后续使用才调用</span></span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDirty) &#123;</span><br><span class="line">        isDirty = <span class="literal">false</span>;</span><br><span class="line">        value = effectFn();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">effect</span>(<span class="params">fn: <span class="built_in">Function</span>, options?: IEffectOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> effectFn: IEffectFn = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    cleanUp(effectFn);</span><br><span class="line">    activeEffectStack.push(effectFn);</span><br><span class="line">    <span class="keyword">const</span> res = fn();</span><br><span class="line">    activeEffectStack.pop();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;;</span><br><span class="line">  effectFn.fnSets = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  effectFn.options = options;</span><br><span class="line">  <span class="comment">// 是否懒调用</span></span><br><span class="line">  <span class="keyword">if</span> (!options?.lazy) effectFn();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> effectFn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表面上看，问题好像都解决了，但还有问题没被发现呢！</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 案例追加</span></span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line"><span class="built_in">console</span>.log(momAge.value);</span><br><span class="line">effect(<span class="function">() =&gt;</span> <span class="built_in">console</span>.log(momAge.value));</span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-2-2.png" alt="效果图"></p>
<p>存在的问题：妈妈的年龄已经改变了，但是 <code>momAge.value</code> 的值却没有改变。</p>
<p>分析原因：<code>computed</code> 函数中的 <code>isDirty</code> 一直为 <code>true</code>，导致 <code>momAge.value</code> 没有重新计算。</p>
<p>解决办法：</p>
<ol>
<li><p><code>isDirty</code> 需要跟随基础值 <code>person.age</code> 与 <code>person.ageBase</code> 的变化而变化。这有点难以捕捉。—— ×</p>
</li>
<li><p>但是，我们已经实现了基础值变化时，计算函数也跟着被再次调用，所以只需在计算函数被调用时，重置 <code>isDirty</code> 即可。—— √</p>
<ul>
<li><p>在计算函数里实现 <code>isDirty</code> —— ×</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> effectFn = effect(</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    isDirty = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span> computedFn();</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDirty) &#123;</span><br><span class="line">      isDirty = <span class="literal">false</span>;</span><br><span class="line">      value = effectFn(); <span class="comment">// isDirty 又是 true 了，下次还得重新计算</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>在 <code>options.schedule</code> 中实现 —— √</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> effectFn = effect(computedFn, &#123;</span><br><span class="line">  <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    isDirty = <span class="literal">true</span>;</span><br><span class="line">    fn();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-2-3.png" alt="效果图"></p>
</li>
</ul>
</li>
<li><p>由 2 中效果图可见，<code>effect(() =&gt; console.log(momAge.value))</code> 未被收集依赖</p>
<ul>
<li>分析原因：<code>momAge.value</code> 就没被收录进响应系统！</li>
<li>解决办法：手动收集响应、手动触发。</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computed</span>(<span class="params">computedFn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> value;</span><br><span class="line">  <span class="keyword">let</span> isDirty = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(computedFn, &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isDirty) &#123;</span><br><span class="line">        isDirty = <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// 手动触发</span></span><br><span class="line">        trigger(<span class="string">&#x27;value&#x27;</span>, obj);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obj = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title">value</span>() &#123;</span><br><span class="line">      <span class="keyword">if</span> (isDirty) &#123;</span><br><span class="line">        isDirty = <span class="literal">false</span>;</span><br><span class="line">        value = effectFn();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 手动收集</span></span><br><span class="line">      track(<span class="string">&#x27;value&#x27;</span>, <span class="built_in">this</span>);</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-2-4.png" alt="效果图"></p>
<h3 id="4-3-watch"><a href="#4-3-watch" class="headerlink" title="4.3 watch"></a>4.3 <code>watch</code></h3><h4 id="4-3-1-监测一个对象"><a href="#4-3-1-监测一个对象" class="headerlink" title="4.3.1 监测一个对象"></a>4.3.1 监测一个对象</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">watch(person, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;person.age&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  effect(<span class="function">() =&gt;</span> traverse(value), &#123;</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      callback();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverse</span>(<span class="params">value: <span class="built_in">any</span>, seen?: <span class="built_in">Set</span>&lt;<span class="built_in">any</span>&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!seen) seen = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value !== <span class="string">&#x27;object&#x27;</span> || value === <span class="literal">null</span> || seen.has(value)) <span class="keyword">return</span>;</span><br><span class="line">  seen.add(value);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> value) &#123;</span><br><span class="line">    traverse(value[key], seen);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么需要遍历整个对象 <code>traverse(value)</code> 呢？</p>
<p><code>Proxy</code> 的拦截操作是针对于对象内部的操作，如对象的值等，对整个对象的读取并无拦截。</p>
<h4 id="4-3-2-监测函数"><a href="#4-3-2-监测函数" class="headerlink" title="4.3.2 监测函数"></a>4.3.2 监测函数</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;person.age&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> getter: <span class="built_in">Function</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span>) getter = value;</span><br><span class="line">  <span class="keyword">else</span> getter = <span class="function">() =&gt;</span> traverse(value);</span><br><span class="line">  effect(getter, &#123;</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      callback();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-2.png" alt="效果图"></p>
<h4 id="4-3-3-回调函数的参数——新值与旧值"><a href="#4-3-3-回调函数的参数——新值与旧值" class="headerlink" title="4.3.3 回调函数的参数——新值与旧值"></a>4.3.3 回调函数的参数——新值与旧值</h4><p>对于值的监测（如 <code>() =&gt; person.age</code>），有新旧值的区别，可能会在回调中使用</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> getter: <span class="built_in">Function</span>;</span><br><span class="line">  <span class="comment">// 新增</span></span><br><span class="line">  <span class="keyword">let</span> oldValue;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span>) getter = value;</span><br><span class="line">  <span class="keyword">else</span> getter = <span class="function">() =&gt;</span> traverse(value);</span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(getter, &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 新增</span></span><br><span class="line">      <span class="keyword">const</span> newValue = effectFn();</span><br><span class="line">      <span class="comment">// 修改</span></span><br><span class="line">      callback(newValue, oldValue);</span><br><span class="line">      <span class="comment">// 新增</span></span><br><span class="line">      oldValue = newValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  oldValue = effectFn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-3.png" alt="效果图"></p>
<h4 id="4-3-4-立即执行"><a href="#4-3-4-立即执行" class="headerlink" title="4.3.4 立即执行"></a>4.3.4 立即执行</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span>, options?: WatchOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> getter: <span class="built_in">Function</span>;</span><br><span class="line">  <span class="keyword">let</span> oldValue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span>) getter = value;</span><br><span class="line">  <span class="keyword">else</span> getter = <span class="function">() =&gt;</span> traverse(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> job = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newValue = effectFn();</span><br><span class="line">    callback(newValue, oldValue);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(getter, &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">scheduler</span>: job</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options?.immediate) job();</span><br><span class="line">  <span class="keyword">else</span> oldValue = effectFn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-4.png" alt="效果图"></p>
<h4 id="4-3-5-回调函数调用时机"><a href="#4-3-5-回调函数调用时机" class="headerlink" title="4.3.5 回调函数调用时机"></a>4.3.5 回调函数调用时机</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">1111</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-5-1.png" alt="效果图"></p>
<p>现在的要求是，将打印语句放在 <code>1111</code> 之后执行。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的信息发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// flush 参数用于指定回调函数执行时机</span></span><br><span class="line">  &#123; <span class="attr">flush</span>: <span class="string">&#x27;post&#x27;</span> &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line">unction <span class="function"><span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span>, options?: WatchOption</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> getter: <span class="built_in">Function</span>;</span><br><span class="line">  <span class="keyword">let</span> oldValue;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span>) getter = value;</span><br><span class="line">  <span class="keyword">else</span> getter = <span class="function">() =&gt;</span> traverse(value);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> job = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> newValue = effectFn();</span><br><span class="line">    callback(newValue, oldValue);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(getter, &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="comment">// 修改部分</span></span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (options?.flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">Promise</span>.resolve().then(job);</span><br><span class="line">      &#125; <span class="keyword">else</span> job();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options?.immediate) job();</span><br><span class="line">  <span class="keyword">else</span> oldValue = effectFn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-5-2.png" alt="效果图"></p>
<h4 id="4-3-6-过期的副作用"><a href="#4-3-6-过期的副作用" class="headerlink" title="4.3.6 过期的副作用"></a>4.3.6 过期的副作用</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 案例代码 */</span></span><br><span class="line"><span class="keyword">const</span> person = reactivity(&#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">24</span>,</span><br><span class="line">  <span class="attr">ageBase</span>: <span class="number">20</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> timer = <span class="number">4000</span>;</span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`年龄发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">    &#125;, timer);</span><br><span class="line">    timer = timer - <span class="number">2000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">person.age++;</span><br><span class="line">person.age++;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-6-1.gif" alt="效果图"></p>
<p>糟糕！返老还童啦！</p>
<p>而实际上，<code>age 24 =&gt; 25</code> 的打印，应该被废弃，只打印 <code>age 25 =&gt; 26</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 实现代码 */</span></span><br><span class="line">watch(</span><br><span class="line">  <span class="function">() =&gt;</span> person.age,</span><br><span class="line">  <span class="function">(<span class="params">newVal, oldVal, onValidate</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 自定义过期条件</span></span><br><span class="line">    <span class="keyword">let</span> isExpired = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    onValidate(<span class="function">() =&gt;</span> (isExpired = <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isExpired) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`年龄发生了变化：age <span class="subst">$&#123;oldVal&#125;</span> =&gt; <span class="subst">$&#123;newVal&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, timer);</span><br><span class="line">    timer = timer - <span class="number">2000</span>;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">watch</span>(<span class="params">value: <span class="built_in">any</span>, callback: <span class="built_in">Function</span>, options?: WatchOption</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> getter: <span class="built_in">Function</span>;</span><br><span class="line">  <span class="keyword">let</span> oldValue;</span><br><span class="line">  <span class="comment">// 用于记录过期函数</span></span><br><span class="line">  <span class="keyword">let</span> cleanUp: <span class="built_in">Function</span> | <span class="literal">null</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;function&#x27;</span>) getter = value;</span><br><span class="line">  <span class="keyword">else</span> getter = <span class="function">() =&gt;</span> traverse(value);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录过期函数的回调</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onValidate</span>(<span class="params">fn: <span class="built_in">Function</span></span>) </span>&#123;</span><br><span class="line">    cleanUp = fn;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> job = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 存在过期函数时，调用</span></span><br><span class="line">    <span class="keyword">if</span> (cleanUp) &#123;</span><br><span class="line">      cleanUp();</span><br><span class="line">      cleanUp = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newValue = effectFn();</span><br><span class="line">    callback(newValue, oldValue, onValidate);</span><br><span class="line">    oldValue = newValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> effectFn = effect(getter, &#123;</span><br><span class="line">    <span class="attr">lazy</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="function"><span class="title">scheduler</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (options?.flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">Promise</span>.resolve().then(job);</span><br><span class="line">      &#125; <span class="keyword">else</span> job();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options?.immediate) job();</span><br><span class="line">  <span class="keyword">else</span> oldValue = effectFn();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/01/19/%E5%B0%8F%E9%B3%84%E9%B1%BC%E5%86%99%E4%BB%A3%E7%A0%81%E4%B9%8BMini-Vue%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F%E7%B3%BB%E7%BB%9F/4-3-6-2.gif" alt="效果图"></p>
<h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><p>核心代码玩 <code>Proxy</code> 和 <code>Map</code>、<code>Set</code>，其他情况就玩的是闭包啦。</p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-<a class="flink" target="_blank" rel="noopener" href="https://github.com/sanjinhub/hexo-theme-geek">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>